<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Kaho Meow Bus å·´å£«ç«™æ™‚é–“</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 10px; text-align: center; }
        input, select, button { padding: 12px; margin: 5px; font-size: 16px; width: 90%; }
        .suggestions { text-align: left; max-height: 200px; overflow-y: auto; background: #f0f0f0; position: absolute; width: 90%; display: none; }
        .suggestions div { padding: 10px; cursor: pointer; }
        .suggestions div:hover { background: #ddd; }
        .eta-entry, .stop-entry { margin-bottom: 15px; text-align: left; padding: 10px; border-bottom: 1px solid #ddd; }
    </style>
    <script>
        let stopDataMap = {};  

        async function loadStopsData() {
            const response = await fetch("https://data.etabus.gov.hk/v1/transport/kmb/stop");
            const data = await response.json();
            
            for (let stop of data.data) {
                let baseName = stop.name_tc.replace(/\(.*?\)/g, "").trim();
                
                if (!stopDataMap[baseName]) {
                    stopDataMap[baseName] = [];
                }
                stopDataMap[baseName].push({ id: stop.stop, fullName: stop.name_tc, lat: stop.lat, lon: stop.long });
            }

            populateDropdown();
        }

        function populateDropdown() {
            const dropdown = document.getElementById("stopDropdown");
            dropdown.innerHTML = "<option value=''>é¸æ“‡å·´å£«ç«™</option>";

            for (const stop in stopDataMap) {
                const option = document.createElement("option");
                option.value = stop;
                option.textContent = stop;
                dropdown.appendChild(option);
            }
        }

        function showSuggestions() {
            let input = document.getElementById("stopInput").value.toLowerCase();
            let suggestionsDiv = document.getElementById("suggestions");
            suggestionsDiv.innerHTML = "";

            if (!input) {
                suggestionsDiv.style.display = "none";
                return;
            }

            let matches = Object.keys(stopDataMap).filter(stop => stop.includes(input));

            if (matches.length === 0) {
                suggestionsDiv.style.display = "none";
                return;
            }

            matches.forEach(match => {
                let div = document.createElement("div");
                div.textContent = match;
                div.onclick = function () {
                    document.getElementById("stopInput").value = match;
                    suggestionsDiv.style.display = "none";
                };
                suggestionsDiv.appendChild(div);
            });

            suggestionsDiv.style.display = "block";
        }

        function getSelectedStopIds() {
            let stopName = document.getElementById("stopInput").value || 
                           document.getElementById("stopDropdown").value;
            return stopDataMap[stopName] || [];
        }

        async function getETA() {
            let stopEntries = getSelectedStopIds();
            if (stopEntries.length === 0) return;

            let etaText = "<h3>é è¨ˆåˆ°é”æ™‚é–“</h3>";

            for (let stopEntry of stopEntries) {
                const response = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/${stopEntry.id}`);
                const data = await response.json();

                data.data.forEach(eta => {
                    let etaTime = new Date(eta.eta);
                    if (!eta.eta || isNaN(etaTime.getTime())) return;

                    let hours = etaTime.getHours();
                    let minutes = etaTime.getMinutes().toString().padStart(2, '0');
                    let countdown = Math.round((etaTime - new Date()) / 60000);
                    let destination = eta.dest_tc || "æœªçŸ¥ç›®çš„åœ°";

                    etaText += `<div class="eta-entry">ğŸ“ ç«™é»: ${stopEntry.fullName} |<br> ğŸšŒ è·¯ç·š ${eta.route} â ${hours}:${minutes} (${countdown} åˆ†é˜å¾Œåˆ°é”) â çµ‚é»ç«™: ${destination}</div>`;
                });
            }

            document.getElementById("eta").innerHTML = etaText;
        }

        function getUserLocation() {
            if (!navigator.geolocation) {
                alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´GPSåŠŸèƒ½ï¼");
                return;
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;

                const response = await fetch("https://data.etabus.gov.hk/v1/transport/kmb/stop");
                const data = await response.json();
                
                let nearestStops = data.data.map(stop => ({
                    name: stop.name_tc,
                    lat: stop.lat,
                    lon: stop.long,
                    distance: getDistance(userLat, userLon, stop.lat, stop.long)
                }));

                nearestStops.sort((a, b) => a.distance - b.distance);
                displayNearestStops(nearestStops.slice(0, 5));
            }, () => {
                alert("ç„¡æ³•ç²å–æ‚¨çš„ä½ç½®ï¼");
            });
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            let R = 6371;
            let dLat = (lat2 - lat1) * (Math.PI / 180);
            let dLon = (lon2 - lon1) * (Math.PI / 180);
            let a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
            let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function displayNearestStops(stops) {
            let stopText = "<h3>æœ€è¿‘çš„å·´å£«ç«™</h3>";
            stops.forEach(stop => {
                stopText += `<div class="stop-entry">ğŸ“ ${stop.name} â è·é›¢ç´„ ${stop.distance.toFixed(2)} å…¬é‡Œ</div>`;
            });
            document.getElementById("nearestStops").innerHTML = stopText;
        }

        document.addEventListener("DOMContentLoaded", loadStopsData);
    </script>
</head>
<body>
    <h1>Kaho Meow Bus å·´å£«ç«™æ™‚é–“</h1>
    <label for="stopInput">è¼¸å…¥æˆ–é¸æ“‡å·´å£«ç«™ï¼š</label>
    <input type="text" id="stopInput" onkeyup="showSuggestions()" placeholder="è¼¸å…¥å·´å£«ç«™åç¨±">
    <div id="suggestions" class="suggestions"></div>
    <select id="stopDropdown"></select>
    <button onclick="getETA()">ç²å–é è¨ˆæ™‚é–“</button>
    <button onclick="getUserLocation()">ç²å–æœ€è¿‘çš„å·´å£«ç«™</button>
    <div id="eta"></div>
    <div id="nearestStops"></div>
</body>
</html>
